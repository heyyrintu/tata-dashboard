# ================================
# TATA Dashboard - Docker Compose
# Production-ready orchestration
# ================================

services:
  # ================================
  # MongoDB Database
  # ================================
  mongodb:
    image: mongo:7.0
    container_name: tata-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME:-admin}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD:-changeme}
      MONGO_INITDB_DATABASE: tata-dashboard
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - tata-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # Uncomment below to expose MongoDB port for external access
    # ports:
    #   - "27017:27017"

  # ================================
  # Backend API Server
  # ================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: tata-backend
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 5000
      MONGODB_URI: mongodb://${MONGO_ROOT_USERNAME:-admin}:${MONGO_ROOT_PASSWORD:-changeme}@mongodb:27017/tata-dashboard?authSource=admin
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost}
      # Appwrite Auth (optional)
      VITE_APPWRITE_ENDPOINT: ${VITE_APPWRITE_ENDPOINT:-}
      VITE_APPWRITE_PROJECT_ID: ${VITE_APPWRITE_PROJECT_ID:-}
      VITE_APPWRITE_ADMIN_TEAM_ID: ${VITE_APPWRITE_ADMIN_TEAM_ID:-}
      # Email Service (optional)
      OUTLOOK_CLIENT_ID: ${OUTLOOK_CLIENT_ID:-}
      OUTLOOK_CLIENT_SECRET: ${OUTLOOK_CLIENT_SECRET:-}
      OUTLOOK_TENANT_ID: ${OUTLOOK_TENANT_ID:-}
      OUTLOOK_UPLOAD_EMAIL: ${OUTLOOK_UPLOAD_EMAIL:-}
      OUTLOOK_ARCHIVE_FOLDER: ${OUTLOOK_ARCHIVE_FOLDER:-Processed}
      OUTLOOK_POLL_INTERVAL: ${OUTLOOK_POLL_INTERVAL:-600000}
    volumes:
      - backend_uploads:/app/uploads
      - backend_logs:/app/logs
    networks:
      - tata-network
    depends_on:
      mongodb:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:5000/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # Frontend (React/Nginx)
  # ================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-/api}
        VITE_APPWRITE_ENDPOINT: ${VITE_APPWRITE_ENDPOINT:-}
        VITE_APPWRITE_PROJECT_ID: ${VITE_APPWRITE_PROJECT_ID:-}
        VITE_APPWRITE_ADMIN_TEAM_ID: ${VITE_APPWRITE_ADMIN_TEAM_ID:-}
    container_name: tata-frontend
    restart: unless-stopped
    networks:
      - tata-network
    depends_on:
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ================================
  # Nginx Reverse Proxy
  # ================================
  nginx:
    image: nginx:alpine
    container_name: tata-nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/docker-nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - tata-network
    depends_on:
      frontend:
        condition: service_healthy
      backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3

# ================================
# Networks
# ================================
networks:
  tata-network:
    driver: bridge

# ================================
# Volumes
# ================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  backend_uploads:
    driver: local
  backend_logs:
    driver: local
